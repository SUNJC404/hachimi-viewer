<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ’­æ”¾ä¸€äº›åŸºç±³ï¼Ÿ</title>
  <style>
    :root {
      --primary-color: #00a1d6;
      --primary-dark: #0087c0;
      --secondary-color: #fb7299;
      --accent-color: #ff6b6b;
      --success-color: #52c41a;
      --danger-color: #ff4d4f;
      --warning-color: #faad14;
      --bg-primary: #ffffff;
      --bg-secondary: #f4f4f4;
      --bg-tertiary: #e7e7e7;
      --bg-card: #ffffff;
      --text-primary: #212121;
      --text-secondary: #505050;
      --text-tertiary: #999999;
      --border-color: #e7e7e7;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --transition-fast: 0.2s ease;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-primary: #181818;
        --bg-secondary: #212121;
        --bg-tertiary: #2a2a2a;
        --bg-card: #242424;
        --text-primary: #e5e5e5;
        --text-secondary: #a0a0a0;
        --text-tertiary: #707070;
        --border-color: #3a3a3a;
      }
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      line-height: 1.6;
    }
    .container { max-width: 1280px; margin: 0 auto; padding: 20px; }

    /* Header */
    .nav-header {
      background-color: var(--bg-primary);
      box-shadow: var(--shadow-sm);
      position: sticky; top: 0; z-index: 100;
    }
    .nav-container {
      max-width: 1280px; margin: 0 auto; display: flex;
      align-items: center; justify-content: space-between;
      padding: 0 16px; height: 64px;
    }
    .logo-text {
      font-size: 20px; font-weight: bold;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    .back-link {
      color: var(--text-primary); text-decoration: none;
      font-size: 16px; font-weight: 500;
      transition: color var(--transition-fast);
    }
    .back-link:hover { color: var(--primary-color); }

    /* Buttons */
    .btn {
      padding: 8px 16px; border: none; border-radius: var(--radius-sm);
      font-size: 14px; font-weight: 500; cursor: pointer;
      transition: all var(--transition-fast);
      text-decoration: none; display: inline-flex; align-items: center; gap: 8px;
      white-space: nowrap; /* Fix for button text wrapping */
    }
    .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-sm); }
    .btn:disabled { transform: none; box-shadow: none; background-color: var(--bg-tertiary) !important; color: var(--text-tertiary) !important; cursor: not-allowed; opacity: 0.7; }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--primary-dark); }
    .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
    .btn-secondary:hover:not(:disabled) { background: var(--border-color); }
    .btn-danger { background: var(--danger-color); color: white; }
    .btn-danger:hover:not(:disabled) { background: #e83a3d; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }

    /* Forms */
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary); }
    .form-input, .form-textarea {
      width: 100%; padding: 10px 15px;
      border: 1px solid var(--border-color);
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      border-radius: var(--radius-sm); font-size: 14px;
      transition: border-color 0.3s ease;
    }
    .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--primary-color); }
    #playlistDescription.form-textarea, #editPlaylistDescription { min-height: 120px; }
    .form-textarea { resize: vertical; min-height: 100px; }
    /* Larger font for title input */
    #editPlaylistTitle { font-size: 20px; font-weight: bold; }


    /* Cards & Headers */
    .card {
      background: var(--bg-card); border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm); padding: 24px; margin-bottom: 20px;
    }
    .card-header {
      display: flex; justify-content: space-between; align-items: flex-start; gap: 16px;
      margin-bottom: 20px; padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    .card-title { font-size: 20px; font-weight: bold; flex-grow: 1; }
    .card-header-actions { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
    .playlist-details { flex-grow: 1; }

    /* Edit Mode Specifics */
    .playlist-edit-footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
      text-align: right;
    }


    /* Modal */
    .modal {
      display: none; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;
      justify-content: center; align-items: center;
    }
    .modal-content {
      position: relative; background: var(--bg-card);
      width: 90%;
      max-width: 650px;
      margin: 50px auto; border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg); display: flex; flex-direction: column;
      max-height: calc(100vh - 80px);
    }
    .modal-header { padding: 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { font-size: 18px; font-weight: bold; }
    .modal-body { padding: 24px; overflow-y: auto; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }
    .modal-close { font-size: 24px; cursor: pointer; color: var(--text-tertiary); background: none; border: none; }

    /* Video list */
    .video-list { display: flex; flex-direction: column; gap: 12px; }
    .video-item {
      display: flex; gap: 15px; padding: 12px; background: var(--bg-secondary);
      border-radius: var(--radius-sm); transition: all 0.2s ease; position: relative;
    }
    .video-item:hover { background: var(--bg-tertiary); transform: translateX(5px); }
    .video-item.dragging { opacity: 0.5; }
    .video-thumbnail { width: 120px; height: 68px; border-radius: var(--radius-sm); object-fit: cover; flex-shrink: 0; }
    .video-info { flex: 1; min-width: 0; }
    .video-title { font-size: 14px; font-weight: 500; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .video-meta { font-size: 12px; color: var(--text-secondary); display: flex; gap: 15px; align-items: center; }
    .video-actions { display: flex; gap: 8px; align-items: center; }
    .drag-handle { cursor: move; color: var(--text-tertiary); padding: 5px; }

    /* Search Section & Modal */
    .search-section { margin-bottom: 30px; }
    .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
    .search-input { flex: 1; }
    #searchModal .modal-content { max-width: 800px; }
    #search-modal-results { display: flex; flex-direction: column; gap: 12px; }
    .search-result-item { display: flex; gap: 12px; padding: 8px; border-radius: var(--radius-sm); align-items: center; }
    .search-result-item:hover { background: var(--bg-secondary); }
    .search-result-thumbnail { width: 120px; height: 68px; border-radius: var(--radius-sm); object-fit: cover; flex-shrink: 0; }
    .search-result-info { flex: 1; min-width: 0;}
    .search-result-title { font-weight: 500; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px;}
    .search-result-meta { font-size: 12px; color: var(--text-secondary); }
    #search-modal-pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 24px; }

    /* Random Playlists & Share Code */
    .playlist-card {
      background: var(--bg-card); border-radius: var(--radius-md); padding: 20px; margin-bottom: 16px;
      box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
    }
    .playlist-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
    .playlist-card-meta-right { display: flex; flex-direction: column; align-items: flex-end; flex-shrink: 0; }
    .share-code-display {
      display: flex; align-items: center; background-color: var(--bg-secondary);
      border: 1px solid var(--border-color); padding: 4px 8px; border-radius: var(--radius-sm);
      font-family: monospace; font-size: 13px; color: var(--text-secondary);
    }
    .share-code-display .copy-btn {
      background: none; border: none; cursor: pointer; padding: 0; margin-left: 8px;
      display: inline-flex; align-items: center; color: var(--text-tertiary);
    }
    .share-code-display .copy-btn:hover { color: var(--primary-color); }
    .share-code-display .copy-btn svg { width: 16px; height: 16px; }
    .playlist-card-views { font-size: 14px; color: var(--text-secondary); text-align: right; margin-top: 8px; }
    .playlist-card-videos { display: flex; flex-wrap: wrap; gap: 10px; }
    .playlist-card-video-cover { width: 120px; height: 68px; border-radius: var(--radius-sm); object-fit: cover; }
    .playlist-card-more-videos { width: 68px; height: 68px; border-radius: var(--radius-sm); background-color: var(--bg-secondary); display: flex; align-items: center; justify-content: center; flex-shrink: 0;}

    /* Utility Styles */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    .success-message { background: rgba(82, 196, 26, 0.1); border: 1px solid rgba(82, 196, 26, 0.3); color: #389e0d; padding: 15px 20px; border-radius: var(--radius-sm); margin-bottom: 20px; }
    .code-display { font-family: monospace; font-size: 16px; background: var(--bg-secondary); padding: 8px 12px; border-radius: var(--radius-sm); display: inline-block; margin: 5px 0; border: 1px solid var(--border-color); }
    .loading { text-align: center; padding: 40px; color: var(--text-secondary); }
    .spinner { border: 3px solid var(--border-color); border-top: 3px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 768px) {
      .video-item { flex-direction: column; }
      .video-thumbnail { width: 100%; height: auto; }
      .modal-content { margin: 20px; max-height: calc(100vh - 40px); }
      .header-actions .btn-primary { display: none; }
    }
  </style>
</head>
<body>
<header class="nav-header">
  <div class="nav-container">
    <a href="/" style="text-decoration: none;"><div class="logo-text">å“ˆåŸºç±³FM</div></a>
    <div class="header-actions">
      <a href="/playlist.html" class="back-link">æ’­æ”¾åˆ—è¡¨é¦–é¡µ</a>
      <input type="text" id="shareCodeInput" class="form-input" style="width: 150px; height: 38px;" placeholder="è¾“å…¥åˆ†äº«ç ">
      <button class="btn btn-secondary" onclick="loadPlaylist()">æŸ¥çœ‹</button>
      <button class="btn btn-primary" onclick="showCreateModal()">+ åˆ›å»º</button>
    </div>
  </div>
</header>

<div class="container">
  <div id="mainContent">
    <div id="random-playlists-section">
      <h2 style="margin-bottom: 20px; font-weight: bold;">å‘ç°æ’­æ”¾åˆ—è¡¨</h2>
      <div id="random-playlists-container"></div>
    </div>
  </div>
</div>

<div id="createModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>åˆ›å»ºæ–°çš„æ’­æ”¾åˆ—è¡¨</h2>
      <button class="modal-close" onclick="closeModal('createModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">æ’­æ”¾åˆ—è¡¨æ ‡é¢˜</label>
        <input type="text" id="playlistTitle" class="form-input" placeholder="ç»™ä½ çš„æ’­æ”¾åˆ—è¡¨èµ·ä¸ªåå­—">
      </div>
      <div class="form-group">
        <label class="form-label">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
        <textarea id="playlistDescription" class="form-textarea" placeholder="æè¿°ä¸€ä¸‹è¿™ä¸ªæ’­æ”¾åˆ—è¡¨"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('createModal')">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="createPlaylist()">åˆ›å»º</button>
    </div>
  </div>
</div>

<div id="editCodeModal" class="modal">
  <div class="modal-content" style="max-width: 400px;">
    <div class="modal-header">
      <h2>è¾“å…¥ç¼–è¾‘ç </h2>
      <button class="modal-close" onclick="closeModal('editCodeModal')">&times;</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 15px; color: var(--text-secondary);">è¯·è¾“å…¥ç¼–è¾‘ç ä»¥ç¼–è¾‘æ­¤æ’­æ”¾åˆ—è¡¨ï¼š</p>
      <input type="text" id="editCodeInput" class="form-input" placeholder="ç¼–è¾‘ç ">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('editCodeModal')">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="validateEditCode()">ç¡®è®¤</button>
    </div>
  </div>
</div>

<div id="searchModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>æœç´¢è§†é¢‘</h2>
      <button class="modal-close" onclick="closeSearchModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="search-modal-results" class="loading"><div class="spinner"></div></div>
      <div id="search-modal-pagination"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeSearchModal()">å®Œæˆ</button>
    </div>
  </div>
</div>


<script>
  let currentPlaylist = null;
  let currentEditCode = null;
  let isEditMode = false;
  let currentSearchQuery = '';
  let currentSearchPage = 1;

  document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const shareCode = urlParams.get('code');
    if (shareCode) {
      document.getElementById('shareCodeInput').value = shareCode;
      loadPlaylist();
    } else {
      loadRandomPlaylists();
    }
  });

  async function loadRandomPlaylists() {
    const container = document.getElementById('random-playlists-container');
    container.innerHTML = '<div class="loading"><div class="spinner"></div><div>åŠ è½½ä¸­...</div></div>';
    try {
      const response = await fetch('/api/playlists/random?limit=5');
      if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');
      const playlists = await response.json();
      displayRandomPlaylists(playlists);
    } catch (error) {
      container.innerHTML = `<div class="card"><p class="empty-state">${error.message}</p></div>`;
    }
  }

  function displayRandomPlaylists(playlists) {
    const container = document.getElementById('random-playlists-container');
    if (!playlists || playlists.length === 0) {
      container.innerHTML = '<div class="card"><p class="empty-state">æš‚æ— éšæœºæ’­æ”¾åˆ—è¡¨</p></div>';
      return;
    }

    const numVideosToShow = 9;
    const copyIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;

    container.innerHTML = playlists.map(playlist => {
      const videosHtml = playlist.videos.slice(0, numVideosToShow).map(video => `
          <img class="playlist-card-video-cover" src="https://images.weserv.nl/?url=${encodeURIComponent(video.coverUrl)}&w=240&h=136&fit=cover&output=webp" alt="${video.title}" referrerpolicy="no-referrer">
      `).join('');

      const moreVideosSvg = playlist.videoCount > numVideosToShow ? `
          <div class="playlist-card-more-videos">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-tertiary);">
                  <circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle>
              </svg>
          </div>
      ` : '';

      return `
          <div class="playlist-card" onclick="loadPlaylistByCode('${playlist.shareCode}')">
              <div class="card-header">
                  <div class="card-title">${playlist.title}</div>
                  <div class="playlist-card-meta-right">
                      <div class="share-code-display">
                          <span>${playlist.shareCode}</span>
                          <button class="copy-btn" title="å¤åˆ¶åˆ†äº«ç " onclick="copyShareCodeOnCard(event, '${playlist.shareCode}', this)">
                              ${copyIconSvg}
                          </button>
                      </div>
                      <div class="playlist-card-views">æŸ¥çœ‹: ${formatViews(playlist.viewCount)}</div>
                  </div>
              </div>
              <div class="playlist-card-videos">
                  ${videosHtml}
                  ${moreVideosSvg}
              </div>
          </div>
      `;
    }).join('');
  }

  async function createPlaylist() {
    const title = document.getElementById('playlistTitle').value.trim();
    const description = document.getElementById('playlistDescription').value.trim();
    if (!title) { alert('è¯·è¾“å…¥æ’­æ”¾åˆ—è¡¨æ ‡é¢˜'); return; }

    try {
      const response = await fetch('/api/playlists', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, description })
      });
      if (!response.ok) { const error = await response.json(); throw new Error(error.error || 'åˆ›å»ºå¤±è´¥'); }
      const data = await response.json();
      closeModal('createModal');
      showCreateSuccess(data);
    } catch (error) { alert('åˆ›å»ºå¤±è´¥: ' + error.message); }
  }

  function showCreateSuccess(data) {
    document.getElementById('mainContent').innerHTML = `
        <div class="card">
            <div class="success-message">
                <h2 style="font-weight: bold; font-size: 1.2em;">ğŸ‰ æ’­æ”¾åˆ—è¡¨åˆ›å»ºæˆåŠŸï¼</h2>
                <p style="margin-top: 10px; color: var(--text-secondary);">è¯·å¦¥å–„ä¿å­˜ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
            </div>
            <div style="margin-top: 20px;">
                <p><strong>åˆ†äº«ç  (Share Code):</strong></p>
                <p><span class="code-display">${data.shareCode}</span></p>
                <p style="margin-top: 5px; font-size: 13px; color: var(--text-secondary);">ä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡åˆ†äº«ç æŸ¥çœ‹ä½ çš„æ’­æ”¾åˆ—è¡¨</p>
            </div>
            <div style="margin-top: 20px;">
                <p><strong>ç¼–è¾‘ç  (Edit Code):</strong></p>
                <p><span class="code-display">${data.editCode}</span></p>
                <p style="margin-top: 5px; font-size: 13px; color: var(--danger-color);">âš ï¸ è¯·åŠ¡å¿…ä¿å­˜ç¼–è¾‘ç ï¼Œä¸¢å¤±åæ— æ³•æ‰¾å›ï¼</p>
            </div>
            <div style="margin-top: 30px; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="loadPlaylistByCode('${data.shareCode}')">ç«‹å³æŸ¥çœ‹</button>
                <button class="btn btn-secondary" onclick="copyToClipboard('${data.shareCode}')">å¤åˆ¶åˆ†äº«ç </button>
            </div>
        </div>`;
  }

  async function loadPlaylist() {
    const shareCode = document.getElementById('shareCodeInput').value.trim();
    if (!shareCode) { alert('è¯·è¾“å…¥åˆ†äº«ç '); return; }
    loadPlaylistByCode(shareCode);
  }

  function goBackToDiscovery() {
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `
      <div id="random-playlists-section">
        <h2 style="margin-bottom: 20px; font-weight: bold;">å‘ç°æ’­æ”¾åˆ—è¡¨</h2>
        <div id="random-playlists-container"></div>
      </div>
    `;
    const url = new URL(window.location);
    url.searchParams.delete('code');
    window.history.pushState({}, '', url);
    loadRandomPlaylists();
  }

  async function loadPlaylistByCode(shareCode) {
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = '<div class="loading"><div class="spinner"></div><div>åŠ è½½ä¸­...</div></div>';
    try {
      const response = await fetch(`/api/playlists/${shareCode}`);
      if (!response.ok) {
        if (response.status === 404) throw new Error('æ’­æ”¾åˆ—è¡¨ä¸å­˜åœ¨ (404)');
        throw new Error('åŠ è½½å¤±è´¥');
      }
      const playlist = await response.json();
      currentPlaylist = playlist;
      displayPlaylist(playlist);
      const url = new URL(window.location);
      url.searchParams.set('code', shareCode);
      window.history.pushState({}, '', url);
    } catch (error) {
      mainContent.innerHTML = `<div class="card"><div class="empty-state"><div class="empty-state-icon">ğŸ˜¢</div><h2>åŠ è½½å¤±è´¥</h2><p>${error.message}</p></div></div>`;
    }
  }

  function displayPlaylist(playlist) {
    const mainContent = document.getElementById('mainContent');
    const copyIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
    const videoListHtml = playlist.videos && playlist.videos.length > 0
            ? playlist.videos.map(video => `
            <div class="video-item" draggable="${isEditMode}" data-id="${video.id}" data-position="${video.position}">
                ${isEditMode ? '<span class="drag-handle">â‰¡</span>' : ''}
                <img class="video-thumbnail" src="https://images.weserv.nl/?url=${encodeURIComponent(video.coverUrl)}&w=480&h=270&fit=cover&output=webp" alt="${video.title}" referrerpolicy="no-referrer">
                <div class="video-info">
                    <div class="video-title" title="${video.title}">${video.title}</div>
                    <div class="video-meta">
                        <span>UP: ${video.owner ? video.owner.name : 'æœªçŸ¥'}</span>
                        <span>â–¶ ${formatViews(video.views)}</span>
                        <span>${formatDate(video.pubDate)}</span>
                    </div>
                </div>
                <div class="video-actions">
                    <a href="https://www.bilibili.com/video/${video.bvid}" target="_blank" class="btn btn-sm btn-secondary">æ’­æ”¾</a>
                    ${isEditMode ? `<button class="btn btn-sm btn-danger" onclick="removeVideo(${video.id})">åˆ é™¤</button>` : ''}
                </div>
            </div>`).join('')
            : '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>æ’­æ”¾åˆ—è¡¨è¿˜æ²¡æœ‰è§†é¢‘ï¼Œå¿«å»æ·»åŠ å§ï¼</p></div>';

    let headerActionsHtml = '';
    if (isEditMode) {
      headerActionsHtml = `
            <button class="btn btn-secondary" onclick="exitEditMode()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="updatePlaylistDetails()">ä¿å­˜æ›´æ”¹</button>
        `;
    } else {
      headerActionsHtml = `
            <div class="share-code-display">
                <span>${playlist.shareCode}</span>
                <button class="copy-btn" title="å¤åˆ¶åˆ†äº«ç " onclick="copyShareCodeOnCard(event, '${playlist.shareCode}', this)">
                    ${copyIconSvg}
                </button>
            </div>
            <button class="btn btn-secondary" onclick="goBackToDiscovery()">è¿”å›</button>
            <button class="btn btn-primary" onclick="enterEditMode()">ç¼–è¾‘</button>
        `;
    }

    let playlistDetailsHtml = `
        <h2 class="card-title">${playlist.title}</h2>
        ${playlist.description ? `<p style="margin-top: 8px; color: var(--text-secondary);">${playlist.description}</p>` : ''}
    `;
    if (isEditMode) {
      playlistDetailsHtml = `
            <div class="form-group">
                <label for="editPlaylistTitle" class="form-label">æ ‡é¢˜</label>
                <input type="text" id="editPlaylistTitle" class="form-input" style="width: 80%" value="${playlist.title}">
            </div>
            <div class="form-group">
                <label for="editPlaylistDescription" class="form-label">ç®€ä»‹</label>
                <textarea id="editPlaylistDescription" class="form-textarea" style="width: 80%">${playlist.description || ''}</textarea>
            </div>
        `;
    }

    let editFooterHtml = '';
    if (isEditMode) {
      editFooterHtml = `
            <div class="playlist-edit-footer">
                <button class="btn btn-danger" onclick="deletePlaylist()">åˆ é™¤æ­¤æ’­æ”¾åˆ—è¡¨</button>
            </div>
        `;
    }

    mainContent.innerHTML = `
        <div class="card">
            <div class="card-header">
                <div class="playlist-details">
                    ${playlistDetailsHtml}
                    ${!isEditMode ? `<p style="margin-top: 8px; font-size: 14px; color: var(--text-secondary);">
                        ${playlist.videoCount || 0} ä¸ªè§†é¢‘ Â· ${formatViews(playlist.viewCount || 0)} æ¬¡æµè§ˆ Â· åˆ›å»ºäº ${formatDate(playlist.createdAt)}
                    </p>` : ''}
                </div>
                <div class="card-header-actions">
                    ${headerActionsHtml}
                </div>
            </div>
            ${isEditMode ? `
                <div class="search-section">
                    <h3 style="margin-bottom: 15px; font-weight: bold;">æ·»åŠ è§†é¢‘</h3>
                    <div class="search-box">
                        <input type="text" id="videoSearchInput" class="form-input search-input" placeholder="é€šè¿‡å…³é”®è¯æˆ–BVIDæœç´¢å“ˆåŸºç±³è§†é¢‘...">
                        <button class="btn btn-primary" onclick="startSearch()">æœç´¢</button>
                    </div>
                </div>` : ''}
            <div class="video-list" id="videoList">${videoListHtml}</div>
            ${editFooterHtml}
        </div>`;

    if (isEditMode) setupDragAndDrop();
  }

  function startSearch() {
    const query = document.getElementById('videoSearchInput').value.trim();
    if (!query) {
      alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
      return;
    }
    currentSearchQuery = query;
    currentSearchPage = 1;
    document.getElementById('searchModal').style.display = 'flex';
    fetchPaginatedSearchResults();
  }

  async function fetchPaginatedSearchResults() {
    const resultsContainer = document.getElementById('search-modal-results');
    const paginationContainer = document.getElementById('search-modal-pagination');
    resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    paginationContainer.innerHTML = '';

    try {
      const response = await fetch(`/api/search?q=${encodeURIComponent(currentSearchQuery)}&page=${currentSearchPage}&hitsPerPage=12`);
      if (!response.ok) throw new Error('æœç´¢å¤±è´¥');
      const results = await response.json();
      renderPaginatedSearchResults(results.hits || []);
      renderSearchPagination(results);
    } catch (error) {
      resultsContainer.innerHTML = `<p style="color: var(--danger-color); text-align: center;">${error.message}</p>`;
    }
  }

  function renderPaginatedSearchResults(videos) {
    const resultsContainer = document.getElementById('search-modal-results');
    if (videos.length === 0 && currentSearchPage === 1) {
      resultsContainer.innerHTML = '<p class="empty-state">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è§†é¢‘</p>';
      return;
    }

    const existingBvids = new Set(currentPlaylist.videos.map(v => v.bvid));

    resultsContainer.innerHTML = videos.map(video => {
      const isAlreadyInPlaylist = existingBvids.has(video.bvid);
      const buttonHtml = isAlreadyInPlaylist
              ? `<button class="btn btn-sm" disabled>å·²åœ¨åˆ—è¡¨ä¸­</button>`
              : `<button class="btn btn-sm btn-primary" onclick="addVideoToPlaylist('${video.bvid}', this)">æ·»åŠ </button>`;

      return `
            <div class="search-result-item" id="search-item-${video.bvid}">
                <img class="search-result-thumbnail" src="https://images.weserv.nl/?url=${encodeURIComponent(video.coverUrl)}&w=320&h=180&fit=cover&output=webp" alt="${video.title}" referrerpolicy="no-referrer">
                <div class="search-result-info">
                    <div class="search-result-title" title="${video.title}">${video.title}</div>
                    <div class="search-result-meta">
                        UP: ${video.owner ? video.owner.name : 'æœªçŸ¥'} Â· â–¶ ${formatViews(video.views)}
                    </div>
                </div>
                ${buttonHtml}
            </div>
        `;
    }).join('');
  }

  function renderSearchPagination(results) {
    const paginationContainer = document.getElementById('search-modal-pagination');
    const totalPages = results.totalPages;
    if (totalPages <= 1) {
      paginationContainer.innerHTML = '';
      return;
    }
    paginationContainer.innerHTML = `
          <button class="btn btn-secondary" onclick="goToSearchPage(${currentSearchPage - 1})" ${currentSearchPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
          <span>ç¬¬ ${currentSearchPage} / ${totalPages} é¡µ</span>
          <button class="btn btn-secondary" onclick="goToSearchPage(${currentSearchPage + 1})" ${currentSearchPage >= totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
      `;
  }

  function goToSearchPage(page) {
    currentSearchPage = page;
    fetchPaginatedSearchResults();
  }

  function closeSearchModal() {
    document.getElementById('searchModal').style.display = 'none';
    if (currentPlaylist) {
      loadPlaylistByCode(currentPlaylist.shareCode);
    }
  }

  async function addVideoToPlaylist(bvid, buttonElement) {
    if (!currentEditCode) { alert('è¯·å…ˆéªŒè¯ç¼–è¾‘ç '); return; }
    buttonElement.disabled = true;
    buttonElement.textContent = 'æ·»åŠ ä¸­...';
    try {
      const response = await fetch(`/api/playlists/${currentPlaylist.shareCode}/videos`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ editCode: currentEditCode, bvid })
      });
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'æ·»åŠ å¤±è´¥');
      }
      buttonElement.textContent = 'å·²æ·»åŠ ';
      buttonElement.classList.remove('btn-primary');
    } catch (error) {
      alert('æ·»åŠ å¤±è´¥: ' + error.message);
      buttonElement.disabled = false;
      buttonElement.textContent = 'æ·»åŠ ';
    }
  }

  async function updatePlaylistDetails() {
    const newTitle = document.getElementById('editPlaylistTitle').value.trim();
    const newDescription = document.getElementById('editPlaylistDescription').value.trim();

    if (!newTitle) {
      alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
      return;
    }

    try {
      const response = await fetch(`/api/playlists/${currentPlaylist.shareCode}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: newTitle,
          description: newDescription,
          editCode: currentEditCode
        })
      });
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'ä¿å­˜å¤±è´¥');
      }
      alert('ä¿å­˜æˆåŠŸï¼');
      exitEditMode(); // Exit edit mode on success
    } catch (error) {
      alert('ä¿å­˜å¤±è´¥: ' + error.message);
    }
  }

  async function deletePlaylist() {
    if (!confirm('æ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ä¸ªæ’­æ”¾åˆ—è¡¨å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
      return;
    }
    try {
      const response = await fetch(`/api/playlists/${currentPlaylist.shareCode}?editCode=${currentEditCode}`, {
        method: 'DELETE'
      });
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'åˆ é™¤å¤±è´¥');
      }
      alert('æ’­æ”¾åˆ—è¡¨å·²æˆåŠŸåˆ é™¤ã€‚');
      goBackToDiscovery(); // Go back to the main page
    } catch (error) {
      alert('åˆ é™¤å¤±è´¥: ' + error.message);
    }
  }

  async function removeVideo(videoId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§†é¢‘å—ï¼Ÿ')) return;
    try {
      const response = await fetch(`/api/playlists/${currentPlaylist.shareCode}/videos/${videoId}?editCode=${currentEditCode}`, { method: 'DELETE' });
      if (!response.ok) { const error = await response.json(); throw new Error(error.error || 'åˆ é™¤å¤±è´¥'); }
      loadPlaylistByCode(currentPlaylist.shareCode);
    } catch (error) { alert('åˆ é™¤å¤±è´¥: ' + error.message); }
  }

  function setupDragAndDrop() {
    const videoList = document.getElementById('videoList');
    if(!videoList) return;
    let draggedElement = null;
    videoList.addEventListener('dragstart', e => { if (e.target.classList.contains('video-item')) { draggedElement = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); } });
    videoList.addEventListener('dragend', e => { if(draggedElement) { draggedElement.classList.remove('dragging'); draggedElement = null; } });
    videoList.addEventListener('dragover', e => { e.preventDefault(); const afterElement = getDragAfterElement(videoList, e.clientY); if (draggedElement) { if (afterElement == null) { videoList.appendChild(draggedElement); } else { videoList.insertBefore(draggedElement, afterElement); } } });
    videoList.addEventListener('drop', async e => {
      e.preventDefault(); if (!draggedElement) return;
      const items = Array.from(videoList.querySelectorAll('.video-item'));
      const draggedId = parseInt(draggedElement.dataset.id);
      const newPosition = items.indexOf(draggedElement) + 1;
      try { await updateVideoPosition(draggedId, newPosition); items.forEach((item, index) => item.dataset.position = index + 1); } catch (error) { alert('æ›´æ–°ä½ç½®å¤±è´¥ï¼Œå°†é‡æ–°åŠ è½½åˆ—è¡¨ã€‚'); loadPlaylistByCode(currentPlaylist.shareCode); }
    });
  }

  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.video-item:not(.dragging)')];
    return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  async function updateVideoPosition(videoId, newPosition) {
    try {
      const response = await fetch(`/api/playlists/${currentPlaylist.shareCode}/videos/${videoId}/position`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ editCode: currentEditCode, position: newPosition })
      });
      if (!response.ok) throw new Error('æ›´æ–°å¤±è´¥');
    } catch (error) { throw error; }
  }

  function copyShareCodeOnCard(event, text, buttonElement) {
    event.stopPropagation();
    navigator.clipboard.writeText(text).then(() => {
      const originalIcon = buttonElement.innerHTML;
      const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--success-color)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
      buttonElement.innerHTML = checkIcon;
      buttonElement.disabled = true;
      setTimeout(() => {
        buttonElement.innerHTML = originalIcon;
        buttonElement.disabled = false;
      }, 2000);
    }).catch(err => {
      console.error('Copy failed', err);
      alert('å¤åˆ¶å¤±è´¥');
    });
  }

  async function validateEditCode() {
    const editCode = document.getElementById('editCodeInput').value.trim();
    if (!editCode) {
      alert('è¯·è¾“å…¥ç¼–è¾‘ç ');
      return;
    }
    try {
      const response = await fetch(`/api/playlists/${currentPlaylist.shareCode}/validate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ editCode })
      });
      const data = await response.json();
      if (data.valid) {
        currentEditCode = editCode;
        isEditMode = true;
        closeModal('editCodeModal');
        displayPlaylist(currentPlaylist);
      } else {
        alert('ç¼–è¾‘ç é”™è¯¯');
      }
    } catch (error) {
      alert('éªŒè¯å¤±è´¥');
    }
  }

  function formatViews(num) { if (num >= 10000) return (num / 10000).toFixed(1) + 'ä¸‡'; return num ? num.toLocaleString() : '0'; }
  function formatDate(dateString) { if (!dateString) return ''; try { return new Date(dateString).toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }); } catch (e) { return ''; } }
  function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')).catch(() => alert('å¤åˆ¶å¤±è´¥')); }
  function showCreateModal() { document.getElementById('createModal').style.display = 'flex'; }
  function enterEditMode() { document.getElementById('editCodeModal').style.display = 'flex'; }
  function exitEditMode() { isEditMode = false; currentEditCode = null; loadPlaylistByCode(currentPlaylist.shareCode); }

  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'none';
      if (modalId === 'editCodeModal') {
        modal.querySelector('#editCodeInput').value = '';
      }
      if (modalId === 'createModal') {
        modal.querySelector('#playlistTitle').value = '';
        modal.querySelector('#playlistDescription').value = '';
      }
    }
  }

  window.onclick = function(event) { if (event.target.classList.contains('modal')) { event.target.style.display = 'none'; } }
  document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeModal('createModal'); closeModal('editCodeModal'); closeModal('searchModal'); } });
  document.addEventListener('keyup', e => {
    const targetId = e.target.id;
    if (e.key === 'Enter') {
      if (targetId === 'shareCodeInput') loadPlaylist();
      if (targetId === 'videoSearchInput') startSearch();
      if (targetId === 'editCodeInput') validateEditCode();
    }
  });
</script>
</body>
</html>